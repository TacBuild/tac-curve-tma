workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" && ($CI_COMMIT_BRANCH == "development" || $CI_COMMIT_BRANCH == "main")'
      when: always
    - when: never

default:
  image: docker:29.0
  tags:
    - gitlab_runner

variables:
  DO_USERNAME: doadmin
  DO_REGISTRY: registry.digitalocean.com
  IMAGE_NAME: curve
  SHORT_SHA: $CI_COMMIT_SHORT_SHA

.build_template:
  stage: build
  image: docker:29.0
  variables:
    DOCKER_BUILDKIT: "1"
  script:
    - echo "Building $DOCKER_IMAGE"
    - echo $DO_PASSWORD | docker login -u $DO_USERNAME --password-stdin $DO_REGISTRY
    - docker build -t $DOCKER_IMAGE .
    - docker push $DOCKER_IMAGE

stages:
  - build
  - deploy

build:
  extends:
    - .build_template
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" && ($CI_COMMIT_BRANCH == "development")'
      variables:
        STAGE: testnet
        DOCKER_IMAGE: $DO_REGISTRY/tac-$STAGE/$IMAGE_NAME:$SHORT_SHA
        DO_PASSWORD: $DO_PASSWORD_TESTNET
        TELEGRAM_THREAD_ID: 2
    - if: '$CI_PIPELINE_SOURCE == "push" && ($CI_COMMIT_BRANCH == "main")'
      variables:
        STAGE: mainnet
        DOCKER_IMAGE: $DO_REGISTRY/tac-$STAGE/$IMAGE_NAME:$SHORT_SHA
        DO_PASSWORD: $DO_PASSWORD_MAINNET
        TELEGRAM_THREAD_ID: 3
    - when: never
  after_script:
    - |
      if [ "$CI_JOB_STATUS" != "success" ]; then
        exit 0
      fi
      apk add --no-cache curl
      MESSAGE=$(cat <<EOF
      ðŸ¦Š *GitLab CI*

      ðŸš€ *${IMAGE_NAME}* image built successfully!
      ðŸ› ï¸ Stage: ${STAGE}
      ðŸ³ Image: \`${DOCKER_IMAGE}\`
      ðŸ”— View Pipeline [#${CI_PIPELINE_ID}](${CI_PIPELINE_URL})
      EOF
      )
      curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
      -d chat_id="${TELEGRAM_CHAT_ID}" \
      -d message_thread_id="${TELEGRAM_THREAD_ID}" \
      -d parse_mode="Markdown" \
      --data-urlencode "text=${MESSAGE}" > /dev/null


deploy:
  stage: deploy
  image: alpine:latest
  variables:
    CI_COMMIT_USER_NAME: "markus24de"
    CI_COMMIT_USER_EMAIL: "markus24de@gmail.com"
    PROJECT_NAME: "ton-app-chain/tac/infrastructure"
    ARGOCD_REPO_NAME: "devops2.0-argo-cd-apps"
    ARGOCD_DEV_APP_PATH: testnet/app/curve.yaml
    ARGOCD_PROD_APP_PATH: mainnet/app/curve.yaml
  before_script:
    - apk add --no-cache git openssh yq
    - mkdir -p ~/.ssh
    - echo "$CI_SSH_PRIVATE_KEY_B64" | base64 -d > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan gitlab.com >> ~/.ssh/known_hosts
    - git config --global user.email "$CI_COMMIT_USER_EMAIL"
    - git config --global user.name "$CI_COMMIT_USER_NAME"
  script:
    - git clone --depth=1 "git@gitlab.com:${PROJECT_NAME}/${ARGOCD_REPO_NAME}.git"
    - cd "$ARGOCD_REPO_NAME"

    - yq -i '(.spec.source.helm.parameters[] | select(.name == "image.tag") ).value = env(IMAGE_TAG)' "$ARGOCD_APP_PATH"

    - git add "$ARGOCD_APP_PATH"
    - git commit -m "Update image tag to $IMAGE_TAG by automation"
    - git push origin main
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "development"'
      variables:
        ARGOCD_APP_PATH: $ARGOCD_DEV_APP_PATH
        IMAGE_TAG: $SHORT_SHA
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "main"'
      variables:
        ARGOCD_APP_PATH: $ARGOCD_PROD_APP_PATH
        IMAGE_TAG: $SHORT_SHA
    - when: never